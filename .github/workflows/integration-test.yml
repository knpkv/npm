name: Integration Tests

on:
  # Run twice daily (9-10 AM and 6-7 PM CET)
  schedule:
    - cron: "0 8,17 * * *"

  # Allow manual trigger
  workflow_dispatch:

  # Run on PRs that modify integration tests or SDK packages
  pull_request:
    paths:
      - "packages/*/test/integration.test.ts"
      - "packages/effect-ai-claude-agent-sdk/src/**"
      - "packages/effect-ai-claude-agent-sdk/package.json"
      - "packages/effect-ai-claude-code-cli/src/**"
      - "packages/effect-ai-claude-code-cli/package.json"
      - "packages/confluence-to-markdown/src/**"
      - "packages/confluence-to-markdown/package.json"
      - ".github/workflows/integration-test.yml"

jobs:
  test-sdk:
    name: SDK Integration Tests (${{ matrix.sdk-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        sdk-version: ["locked", "latest"]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Update to latest Anthropic SDK
        if: matrix.sdk-version == 'latest'
        run: |
          cd packages/effect-ai-claude-agent-sdk
          pnpm add @anthropic-ai/claude-agent-sdk@latest

      - name: Build SDK package
        run: pnpm --filter @knpkv/effect-ai-claude-agent-sdk build

      - name: Run SDK integration tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: pnpm --filter @knpkv/effect-ai-claude-agent-sdk test:integration

  test-confluence:
    name: Confluence CLI Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm --filter @knpkv/confluence-api-client --filter @knpkv/confluence-to-markdown build

      - name: Run integration tests
        env:
          CONFLUENCE_BASE_URL: ${{ vars.CONFLUENCE_BASE_URL }}
          CONFLUENCE_ROOT_PAGE_ID: ${{ vars.CONFLUENCE_ROOT_PAGE_ID }}
          CONFLUENCE_API_KEY: ${{ secrets.CONFLUENCE_API_KEY }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
        run: pnpm --filter @knpkv/confluence-to-markdown test:integration
